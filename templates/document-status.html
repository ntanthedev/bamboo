{% extends 'base.html' %}

{% block title %}Trạng thái tài liệu - {{ document.title|default:'BambooLab' }}{% endblock %}

{% block styles %}
<style>
    /* Chỉ giữ lại các style riêng cho trang document-status */
    .status-icon {
        font-size: 48px;
        margin-bottom: 20px;
    }
    .status-pending {
        color: #ffc107;
    }
    .status-processing {
        color: #0d6efd;
    }
    .status-completed {
        color: #198754;
    }
    .status-failed {
        color: #dc3545;
    }
    .progress {
        height: 10px;
        border-radius: 5px;
    }
    .question-item {
        border-left: 4px solid #0d6efd;
        transition: all 0.3s;
    }
    .question-item:hover {
        background-color: #f8f9fa;
    }
    /* CSS cho card và container */
    .content-container {
        max-width: 800px;
        margin: 2rem auto; 
        padding: 0 15px;
    }
    .card {
        margin-bottom: 1.5rem;
        border: none;
        border-radius: .75rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.07);
    }
    .card-header {
        background-color: var(--light-bg);
        border-bottom: 1px solid var(--border-color);
        font-weight: 600;
        color: var(--primary-dark);
    }
    .btn {
        border-radius: 50px;
    }
    .btn-primary {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        border: none;
    }
    .btn-primary:hover {
        background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-color) 100%);
    }
    .btn-outline-secondary {
        border-color: #ccc;
        color: #6c757d;
    }
    .btn-outline-secondary:hover {
        background-color: #e9ecef;
        border-color: #ccc;
        color: #343a40;
    }
</style>
{% endblock %}

{% block content %}
<div class="content-container py-5">
    <h1 class="mb-4 text-center">Trạng thái xử lý tài liệu</h1>
    
    <div class="card shadow-sm mb-4">
        <div class="card-body text-center">
            {% if document.status == 'pending' %}
                <i class="fas fa-clock status-icon status-pending"></i>
                <h4>Đang chờ xử lý</h4>
                <p class="text-muted">Tài liệu của bạn đang trong hàng đợi chờ xử lý.</p>
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning" role="progressbar" style="width: {% if document.progress > 0 %}{{ document.progress }}{% else %}15{% endif %}%" aria-valuenow="{% if document.progress > 0 %}{{ document.progress }}{% else %}15{% endif %}" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                {% if document.progress_message %}
                <p class="text-muted progress-message">{{ document.progress_message }}</p>
                {% endif %}
            {% elif document.status == 'processing' %}
                <i class="fas fa-cog fa-spin status-icon status-processing"></i>
                <h4>Đang xử lý</h4>
                <p class="text-muted">Tài liệu của bạn đang được xử lý. Vui lòng đợi...</p>
                <div class="progress mb-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: {% if document.progress > 0 %}{{ document.progress }}{% else %}55{% endif %}%" aria-valuenow="{% if document.progress > 0 %}{{ document.progress }}{% else %}55{% endif %}" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                {% if document.progress_message %}
                <p class="text-muted progress-message">{{ document.progress_message }}</p>
                {% endif %}
            {% elif document.status == 'completed' %}
                <i class="fas fa-check-circle status-icon status-completed"></i>
                <h4>Hoàn thành</h4>
                <p class="text-muted">Tài liệu của bạn đã được xử lý thành công!</p>
                <div class="progress mb-3">
                    <div class="progress-bar bg-success" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            {% elif document.status == 'failed' %}
                <i class="fas fa-exclamation-circle status-icon status-failed"></i>
                <h4>Xử lý thất bại</h4>
                <p class="text-muted">Không thể xử lý tài liệu của bạn.</p>
                <div class="alert alert-danger">
                    {{ document.error_message|default:"Đã xảy ra lỗi không xác định." }}
                </div>
            {% endif %}
        </div>
    </div>
    
    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0">Thông tin tài liệu</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Tiêu đề:</strong> {{ document.title }}</p>
                    <p><strong>Môn học:</strong> {{ document.subject }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Trạng thái:</strong> 
                        <span class="badge 
                        {% if document.status == 'pending' %}bg-warning
                        {% elif document.status == 'processing' %}bg-primary
                        {% elif document.status == 'completed' %}bg-success
                        {% elif document.status == 'failed' %}bg-danger
                        {% endif %}">
                            {{ document.get_status_display }}
                        </span>
                    </p>
                    <p><strong>Thời gian upload:</strong> {{ document.uploaded_at|date:"d/m/Y H:i" }}</p>
                </div>
            </div>
        </div>
    </div>
    
    {% if document.status == 'completed' %}
    <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Câu hỏi đã tạo ({{ question_count }})</h5>
            <a href="{% url 'quiz-list' %}" class="btn btn-sm btn-primary">
                <i class="fas fa-list me-1"></i> Xem danh sách Quiz
            </a>
        </div>
        <div class="card-body">
            {% if questions %}
                <div class="list-group">
                    {% for question in questions %}
                    <div class="list-group-item question-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="mb-1">{{ question.text|truncatechars:70 }}</p>
                                <small class="text-muted">
                                    <i class="fas fa-tag me-1"></i>{{ question.get_difficulty_display }}
                                </small>
                            </div>
                            <a href="{% url 'admin:core_question_changelist' %}{{ question.id }}" target="_blank" class="btn btn-sm btn-outline-secondary" title="Quản lý các câu hỏi của tài liệu này trong admin">
                                <i class="fas fa-edit me-1"></i>Quản lý Câu hỏi
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="alert alert-info">
                    Không tìm thấy câu hỏi nào. Có thể đã xảy ra lỗi trong quá trình phân tích tài liệu.
                </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
    
    <div class="text-center mt-4">
        <a href="{% url 'upload-document' %}" class="btn btn-primary">
            <i class="fas fa-upload me-1"></i>Upload tài liệu khác
        </a>
        <a href="{% url 'quiz-list' %}" class="btn btn-outline-secondary ms-2">
            <i class="fas fa-list me-1"></i>Danh sách trắc nghiệm
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Auto refresh page if document is in pending or processing state
        {% if document.status == 'pending' or document.status == 'processing' %}
        const refreshInterval = 3000; // Làm mới mỗi 3 giây
        const progressBar = document.querySelector('.progress-bar');
        const progressMessage = document.querySelector('.text-muted');

        // Bắt đầu làm mới định kỳ
        const refreshTimer = setInterval(function() {
            // Gọi API để lấy tiến trình mới nhất
            fetch('/api/document-status/{{ document.id }}/')
                .then(response => response.json())
                .then(data => {
                    // Cập nhật tiến trình và thông báo
                    if (progressBar) {
                        progressBar.style.width = data.progress + '%';
                        progressBar.setAttribute('aria-valuenow', data.progress);
                    }
                    
                    // Cập nhật thông báo tiến trình nếu có
                    if (data.progress_message && document.querySelector('.progress-message')) {
                        document.querySelector('.progress-message').textContent = data.progress_message;
                    }
                    
                    // Nếu trạng thái đã thay đổi, tải lại trang
                    if (data.status !== '{{ document.status }}') {
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error fetching progress:', error);
                });
        }, refreshInterval);

        // Làm mới toàn bộ trang sau một khoảng thời gian dài hơn
        setTimeout(function() {
            clearInterval(refreshTimer);
            location.reload();
        }, 30000); // Làm mới trang sau 30 giây
        {% endif %}
    });
</script>
{% endblock %} 